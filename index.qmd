---
title: "RWD Working Group Dashboard"
format: 
  html:
    page-layout: full
---

```{r setup}
#| include: false

# Load required libraries
library(googlesheets4)
library(dplyr)
library(ggplot2)
library(plotly)
library(lubridate)
library(tidyr)
library(scales)

# Disable authentication for public sheets
gs4_deauth()
```

::: {.dashboard-header}
# RWD Working Group Resource Inventory
### Interactive Dashboard

Explore the comprehensive inventory of Real World Data resources from across CTSA institutions. This dashboard provides real-time insights from our collaborative Google Sheets inventory.
:::

```{r load-data}
#| cache: false

# RWD Working Group Inventory Google Sheet
SHEET_URL <- "https://docs.google.com/spreadsheets/d/1L8VTkbA0bsEYAceLyYebYPxwETYyF2jzdvoCuqibE-s/edit?gid=0#gid=0"

# Load data from Google Sheets
tryCatch({
  # Read the Inventory tab (skip first row which is headers grouping)
  data_raw <- read_sheet(SHEET_URL, sheet = "Inventory", skip = 1)
  
  # Clean up the data - remove completely empty rows
  data <- data_raw %>%
    filter(!is.na(Title) & Title != "" & Title != "Title") %>%
    # Select key columns of interest
    select(
      Title,
      Type,
      Topic,
      Organization,
      `RWD Type`,
      `URL(s)`,
      Description,
      `Intended Audience`,
      Availability = starts_with("Availability")
    )
  
}, error = function(e) {
  stop(paste("Error loading data from Google Sheets:", e$message, 
             "\nMake sure the sheet is public and the URL is correct."))
})

# Get last update time
last_update <- format(Sys.time(), "%B %d, %Y at %I:%M %p %Z")
```

## Key Metrics

::: {.metrics-grid}

::: {.metric-card}
<div class="metric-label">Total Resources</div>
<div class="metric-value">`r nrow(data)`</div>
:::

::: {.metric-card}
<div class="metric-label">Unique Organizations</div>
<div class="metric-value">`r length(unique(data$Organization[!is.na(data$Organization)]))`</div>
:::

::: {.metric-card}
<div class="metric-label">Resource Types</div>
<div class="metric-value">`r length(unique(data$Type[!is.na(data$Type)]))`</div>
:::

::: {.metric-card}
<div class="metric-label">Topics Covered</div>
<div class="metric-value">`r length(unique(unlist(strsplit(paste(data$Topic[!is.na(data$Topic)], collapse = ", "), ", "))))`</div>
:::

:::

## Visualizations

### Resources by Organization

::: {.chart-container}
```{r plot-organizations}
#| fig-width: 10
#| fig-height: 6

# Count resources by organization (top 15)
org_counts <- data %>%
  filter(!is.na(Organization) & Organization != "") %>%
  count(Organization, sort = TRUE) %>%
  head(15) %>%
  mutate(Organization = reorder(Organization, n))

p1 <- ggplot(org_counts, aes(x = n, y = Organization)) +
  geom_col(fill = "#3498db", alpha = 0.8) +
  geom_text(aes(label = n), hjust = -0.2, size = 4) +
  labs(
    title = "Top 15 Organizations by Resource Count",
    x = "Number of Resources",
    y = ""
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    panel.grid.major.y = element_blank()
  ) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1)))

ggplotly(p1, tooltip = c("y", "x")) %>%
  layout(hovermode = "closest")
```
:::

### Distribution by RWD Type

::: {.chart-container}
```{r plot-rwd-types}
#| fig-width: 10
#| fig-height: 5

# Parse and count RWD Types (they may be comma-separated)
rwd_types <- data %>%
  filter(!is.na(`RWD Type`) & `RWD Type` != "") %>%
  separate_rows(`RWD Type`, sep = ",\\s*") %>%
  count(`RWD Type`, sort = TRUE) %>%
  head(12) %>%
  mutate(`RWD Type` = reorder(`RWD Type`, n))

p2 <- ggplot(rwd_types, aes(x = n, y = `RWD Type`, fill = n)) +
  geom_col() +
  scale_fill_gradient(low = "#3498db", high = "#2c3e50") +
  geom_text(aes(label = n), hjust = -0.2, size = 4) +
  labs(
    title = "Resources by RWD Type",
    x = "Count",
    y = ""
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "none",
    panel.grid.major.y = element_blank()
  ) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.15)))

ggplotly(p2, tooltip = c("y", "x")) %>%
  layout(hovermode = "closest")
```
:::

### Topics Coverage

::: {.chart-container}
```{r plot-topics}
#| fig-width: 10
#| fig-height: 6

# Parse and count Topics (they may be comma-separated)
topics <- data %>%
  filter(!is.na(Topic) & Topic != "") %>%
  separate_rows(Topic, sep = ",\\s*") %>%
  count(Topic, sort = TRUE) %>%
  head(15) %>%
  mutate(Topic = reorder(Topic, n))

p3 <- ggplot(topics, aes(x = n, y = Topic)) +
  geom_col(fill = "#27ae60", alpha = 0.8) +
  geom_text(aes(label = n), hjust = -0.2, size = 4) +
  labs(
    title = "Top 15 Topics",
    x = "Number of Resources",
    y = ""
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    panel.grid.major.y = element_blank()
  ) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1)))

ggplotly(p3, tooltip = c("y", "x")) %>%
  layout(hovermode = "closest")
```
:::

### Availability Status

::: {.chart-container}
```{r plot-availability}
#| fig-width: 10
#| fig-height: 5

# Count by availability
availability <- data %>%
  filter(!is.na(Availability) & Availability != "") %>%
  separate_rows(Availability, sep = ",\\s*") %>%
  count(Availability, sort = TRUE)

p4 <- ggplot(availability, aes(x = "", y = n, fill = Availability)) +
  geom_col(width = 1, color = "white") +
  coord_polar("y") +
  scale_fill_brewer(palette = "Set3") +
  labs(
    title = "Resources by Availability",
    fill = "Availability"
  ) +
  theme_void(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    legend.position = "right"
  )

ggplotly(p4) %>%
  layout(showlegend = TRUE)
```
:::

## Resource Inventory Table

::: {.chart-container}
```{r data-table}
library(DT)

# Create a display version with clickable URLs
data_display <- data %>%
  mutate(
    # Make URLs clickable if they exist
    URL = ifelse(!is.na(`URL(s)`) & `URL(s)` != "",
                 sprintf('<a href="%s" target="_blank">Link</a>', `URL(s)`),
                 ""),
    # Truncate description for display
    Description_Short = ifelse(!is.na(Description),
                               substr(Description, 1, 100),
                               "")
  ) %>%
  select(Title, Organization, Type, `RWD Type`, Topic, Availability, URL, Description_Short) %>%
  arrange(Organization, Title)

datatable(
  data_display,
  escape = FALSE,  # Allow HTML in URL column
  options = list(
    pageLength = 15,
    scrollX = TRUE,
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel'),
    columnDefs = list(
      list(width = '250px', targets = 0),  # Title
      list(width = '150px', targets = 1),  # Organization
      list(width = '100px', targets = c(2, 3, 5)),  # Type, RWD Type, Availability
      list(width = '150px', targets = 4),  # Topic
      list(width = '50px', targets = 6),   # URL
      list(width = '300px', targets = 7)   # Description
    )
  ),
  filter = "top",
  class = 'cell-border stripe hover',
  rownames = FALSE,
  colnames = c('Title', 'Organization', 'Type', 'RWD Type', 'Topic', 'Availability', 'URL', 'Description')
)
```
:::

::: {.last-updated}
Last updated: `r last_update`
:::

