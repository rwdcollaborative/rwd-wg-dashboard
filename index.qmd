---
title: "RWD Training Inventory"
format: 
  html:
    page-layout: full
---

```{r setup}
#| include: false

# Load required libraries
library(googlesheets4)
library(dplyr)
library(ggplot2)
library(plotly)
library(lubridate)
library(tidyr)
library(scales)
library(RColorBrewer)

# Disable authentication for public sheets
gs4_deauth()

# Helper function to parse CSV-style quoted strings from Google Sheets
parse_csv_string <- function(x) {
  # Handle NA or empty strings
  if (is.na(x) || x == "") return(character(0))
  # Split on commas that are not inside quotes
  # This regex splits on commas not inside quoted sections
  parsed <- unlist(strsplit(x, ",(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)", perl = TRUE))
  # Remove quotes and trim whitespace
  parsed <- gsub('^\\s*"?|"?\\s*$', '', parsed)
  # Handle escaped quotes
  parsed <- gsub('\\\\"', '"', parsed)
  return(trimws(parsed))
}
```

::: {.dashboard-header}
# Real-World Data Training Resource Inventory
### Interactive Dashboard

Explore educational and training Real World Data resources from across CTSA institutions and beyond. This dashboard provides real-time insights from our collaborative [Google Sheets inventory](https://docs.google.com/spreadsheets/d/1L8VTkbA0bsEYAceLyYebYPxwETYyF2jzdvoCuqibE-s/edit), contributions welcome!
:::

```{r load-data}
#| cache: false

# RWD Working Group Inventory Google Sheet
SHEET_URL <- "https://docs.google.com/spreadsheets/d/1L8VTkbA0bsEYAceLyYebYPxwETYyF2jzdvoCuqibE-s/edit?gid=0#gid=0"

# Load data from Google Sheets
tryCatch({
  # Read the Inventory tab (skip first row which is headers grouping)
  data_raw <- read_sheet(SHEET_URL, sheet = "Inventory", skip = 1)
  
  # Clean up the data - remove completely empty rows
  data <- data_raw %>%
    filter(!is.na(Title) & Title != "" & Title != "Title") %>%
    # Select key columns of interest
    select(
      Title,
      Type,
      Topic,
      Organization,
      `RWD Type`,
      `URL(s)`,
      Description,
      `Intended Audience`,
      Availability = starts_with("Availability")
    )
  
}, error = function(e) {
  stop(paste("Error loading data from Google Sheets:", e$message, 
             "\nMake sure the sheet is public and the URL is correct."))
})

# Get last update time
last_update <- format(Sys.time(), "%B %d, %Y at %I:%M %p %Z")
```

::: {.metrics-grid}

::: {.metric-card}
<div class="metric-label">Total Resources</div>
<div class="metric-value">`r nrow(data)`</div>
:::

::: {.metric-card}
<div class="metric-label">Organizations</div>
<div class="metric-value">`r length(unique(data$Organization[!is.na(data$Organization)]))`</div>
:::

::: {.metric-card}
<div class="metric-label">RWD Types</div>
<div class="metric-value">`r length(unique(data$Type[!is.na(data$Type)]))`</div>
:::

::: {.metric-card}
<div class="metric-label">RWD Topics</div>
<div class="metric-value">`r length(unique(unlist(strsplit(paste(data$Topic[!is.na(data$Topic)], collapse = ", "), ", "))))`</div>
:::

:::

### By Organization

::: {.chart-container}
```{r plot-organizations}
#| fig-width: 10
#| fig-height: 6

# Count resources by organization
org_counts_raw <- data %>%
  filter(!is.na(Organization) & Organization != "") %>%
  count(Organization, sort = TRUE)

# Separate organizations with 1 resource vs. more than 1
org_counts <- org_counts_raw %>%
  mutate(DisplayOrg = ifelse(n == 1, "Other", Organization)) %>%
  group_by(DisplayOrg) %>%
  summarise(n = sum(n), .groups = 'drop')

# Count how many institutions are in "Other" and update label
other_count <- sum(org_counts_raw$n == 1)
other_row <- org_counts %>% filter(DisplayOrg == "Other")

# Separate "Other" from the rest and sort
org_counts_without_other <- org_counts %>% 
  filter(DisplayOrg != "Other") %>%
  arrange(n)  # Sort ascending by count

org_counts_other <- org_counts %>% 
  filter(DisplayOrg == "Other") %>%
  mutate(DisplayOrg = paste0("Other (", other_count, " institutions)"))

# Put "Other" at the bottom (first in the list for ascending order)
org_counts <- bind_rows(org_counts_other, org_counts_without_other)

plot_ly(org_counts, 
        x = ~n, 
        y = ~DisplayOrg, 
        type = 'bar',
        orientation = 'h',
        marker = list(color = '#3498db'),
        textposition = 'auto',
        insidetextfont = list(color = '#f8fafc'),
        outsidetextfont = list(color = '#2c3e50'),
        text = ~paste0(DisplayOrg, ": ", n, " resources"),
        hoverinfo = 'text') %>%
  layout(title = list(text = "Organizations by Resource Count",
                      font = list(size = 16)),
         xaxis = list(title = "Number of Resources"),
         yaxis = list(title = "", categoryorder = "array", 
                      categoryarray = org_counts$DisplayOrg,
                      showticklabels = FALSE),
         hovermode = "closest",
         margin = list(l = 80))
```
:::

### By RWD Type

::: {.chart-container}
```{r plot-rwd-types}
#| fig-width: 10
#| fig-height: 5

# Parse and count RWD Types (they may be comma-separated with quotes)
rwd_types_parsed <- data %>%
  filter(!is.na(`RWD Type`) & `RWD Type` != "") %>%
  rowwise() %>%
  mutate(RWD_list = list(parse_csv_string(`RWD Type`))) %>%
  ungroup() %>%
  select(-`RWD Type`) %>%  # Remove original column before unnesting
  unnest(RWD_list)

rwd_types <- rwd_types_parsed %>%
  count(RWD_list, sort = TRUE, name = "n") %>%
  rename(`RWD Type` = RWD_list) %>%
  head(12) %>%
  arrange(n)  # Sort for plotly

# Create color gradient
colors <- colorRampPalette(c("#3498db", "#2c3e50"))(nrow(rwd_types))

plot_ly(rwd_types, 
        x = ~n, 
        y = ~`RWD Type`, 
        type = 'bar',
        orientation = 'h',
        marker = list(color = colors),
        text = ~paste0(`RWD Type`, ": ", n, " resources"),
        hoverinfo = 'text') %>%
  layout(title = list(text = "Resources by RWD Type",
                      font = list(size = 16)),
         xaxis = list(title = "Count"),
         yaxis = list(title = "", categoryorder = "total ascending", showticklabels = FALSE),
         hovermode = "closest",
         showlegend = FALSE,
         margin = list(l = 80))
```
:::

### By RWD Topic

::: {.chart-container}
```{r plot-topics}
#| fig-width: 10
#| fig-height: 6

# Parse and count Topics (they may be comma-separated with quotes)
topics_parsed <- data %>%
  filter(!is.na(Topic) & Topic != "") %>%
  rowwise() %>%
  mutate(Topic_list = list(parse_csv_string(Topic))) %>%
  ungroup() %>%
  select(-Topic) %>%  # Remove original column before unnesting
  unnest(Topic_list)

topics <- topics_parsed %>%
  count(Topic_list, sort = TRUE, name = "n") %>%
  rename(Topic = Topic_list) %>%
  head(15) %>%
  arrange(n)  # Sort for plotly

plot_ly(topics, 
        x = ~n, 
        y = ~Topic, 
        type = 'bar',
        orientation = 'h',
        marker = list(color = '#27ae60'),
        text = ~paste0(Topic, ": ", n, " resources"),
        hoverinfo = 'text') %>%
  layout(title = list(text = "Top 15 Topics",
                      font = list(size = 16)),
         xaxis = list(title = "Number of Resources"),
         yaxis = list(title = "", categoryorder = "total ascending", showticklabels = FALSE),
         hovermode = "closest",
         margin = list(l = 80))
```
:::

### Availability

::: {.chart-container}
```{r plot-availability}
#| fig-width: 10
#| fig-height: 5

# Count by availability - handle Google Sheets CSV-style quoting
availability_parsed <- data %>%
  filter(!is.na(Availability) & Availability != "") %>%
  rowwise() %>%
  mutate(Availability_list = list(parse_csv_string(Availability))) %>%
  ungroup() %>%
  select(-Availability) %>%  # Remove original column before unnesting
  unnest(Availability_list) %>%
  rename(Availability = Availability_list)

# Count and plot
availability <- availability_parsed %>%
  count(Availability, sort = TRUE) %>%
  mutate(Availability = reorder(Availability, n))

# Use native plotly for better pie chart
plot_ly(availability, 
        labels = ~Availability, 
        values = ~n, 
        type = 'pie',
        hole = 0.55,
        textposition = 'inside',
        textinfo = 'percent',
        hovertemplate = "%{label}<br>Count: %{value}<br>%{percent}<extra></extra>",
        marker = list(colors = RColorBrewer::brewer.pal(n = nrow(availability), name = "Set3"))) %>%
  layout(title = list(text = "Resources by Availability", 
                      font = list(size = 16, family = "sans-serif")),
         showlegend = TRUE,
         legend = list(orientation = "v"),
         annotations = list(
           list(
             text = paste0("N = ", sum(availability$n)),
             x = 0.5,
             y = 0.5,
             showarrow = FALSE,
             font = list(size = 18)
           )
         ))
```
:::

## Inventory Table

::: {.chart-container}
```{r data-table}
library(DT)

# Helper for display-safe values
safe_text <- function(x) {
  ifelse(is.na(x) | trimws(x) == "", "Not provided", as.character(htmltools::htmlEscape(x)))
}

# Build compact rows plus expandable details
data_display <- data %>%
  mutate(
    First_URL = vapply(`URL(s)`, function(x) {
      parsed <- parse_csv_string(x)
      if (length(parsed) > 0) parsed[[1]] else NA_character_
    }, character(1)),
    Title_Tooltip = ifelse(
      is.na(Description) | trimws(Description) == "",
      "No description provided",
      as.character(htmltools::htmlEscape(Description))
    ),
    Title_Cell = paste0(
      '<div class="inventory-title" title="', Title_Tooltip, '">', safe_text(Title), '</div>',
      '<div class="inventory-meta">',
      '<span class="meta-chip">Type: ', safe_text(Type), '</span>',
      '<span class="meta-chip">RWD: ', safe_text(`RWD Type`), '</span>',
      '<span class="meta-chip">Availability: ', safe_text(Availability), '</span>',
      '</div>'
    ),
    Actions = ifelse(
      !is.na(First_URL) & First_URL != "",
      sprintf('<a href="%s" target="_blank" rel="noopener noreferrer">Open</a>', htmltools::htmlEscape(First_URL)),
      ""
    ),
    Details = paste0(
      '<div class="resource-details">',
      '<div class="detail-row"><span class="detail-label">Topic</span><span class="detail-value">', safe_text(Topic), '</span></div>',
      '<div class="detail-row"><span class="detail-label">Description</span><span class="detail-value">', safe_text(Description), '</span></div>',
      '<div class="detail-row"><span class="detail-label">RWD Type</span><span class="detail-value">', safe_text(`RWD Type`), '</span></div>',
      '<div class="detail-row"><span class="detail-label">Intended Audience</span><span class="detail-value">', safe_text(`Intended Audience`), '</span></div>',
      '<div class="detail-row"><span class="detail-label">All URLs</span><span class="detail-value">', safe_text(`URL(s)`), '</span></div>',
      '</div>'
    )
  ) %>%
  transmute(
    Title = Title_Cell,
    Organization = safe_text(Organization),
    Actions = Actions,
    Type = safe_text(Type),
    Availability = safe_text(Availability),
    `RWD Type` = safe_text(`RWD Type`),
    Details
  ) %>%
  arrange(Organization, Title)

datatable(
  data_display,
  extensions = 'Buttons',
  escape = FALSE,
  options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel'),
    paging = FALSE,
    scrollX = TRUE,
    scrollY = "560px",
    scrollCollapse = TRUE,
    order = list(list(1, "asc"), list(0, "asc")),
    columnDefs = list(
      list(width = '55%', targets = 0),
      list(width = '28%', targets = 1),
      list(width = '7%', targets = 2),
      list(visible = FALSE, targets = c(3, 4, 5, 6))
    )
  ),
  callback = JS(
    "table.on('click', 'tbody td', function(e) {",
    "  if ($(e.target).closest('a, button, input').length) return;",
    "  var tr = $(this).closest('tr');",
    "  if (tr.hasClass('child')) return;",
    "  var row = table.row(tr);",
    "  if (row.child.isShown()) {",
    "    row.child.hide();",
    "    tr.removeClass('shown');",
    "  } else {",
    "    row.child(row.data()[6]).show();",
    "    tr.addClass('shown');",
    "  }",
    "});"
  ),
  filter = "top",
  class = 'cell-border stripe hover compact inventory-table',
  rownames = FALSE,
  colnames = c('Title', 'Organization', 'Open', 'Type', 'Availability', 'RWD Type', 'Details')
)
```
:::

::: {.last-updated}
Last updated: `r last_update`
:::
