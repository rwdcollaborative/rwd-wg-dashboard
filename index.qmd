---
title: "RWD Working Group Dashboard"
format: 
  html:
    page-layout: full
---

```{r setup}
#| include: false

# Load required libraries
library(googlesheets4)
library(dplyr)
library(ggplot2)
library(plotly)
library(lubridate)
library(tidyr)
library(scales)
library(RColorBrewer)

# Disable authentication for public sheets
gs4_deauth()
```

::: {.dashboard-header}
# RWD Working Group Resource Inventory
### Interactive Dashboard

Explore the comprehensive inventory of Real World Data resources from across CTSA institutions. This dashboard provides real-time insights from our collaborative Google Sheets inventory.
:::

```{r load-data}
#| cache: false

# RWD Working Group Inventory Google Sheet
SHEET_URL <- "https://docs.google.com/spreadsheets/d/1L8VTkbA0bsEYAceLyYebYPxwETYyF2jzdvoCuqibE-s/edit?gid=0#gid=0"

# Load data from Google Sheets
tryCatch({
  # Read the Inventory tab (skip first row which is headers grouping)
  data_raw <- read_sheet(SHEET_URL, sheet = "Inventory", skip = 1)
  
  # Clean up the data - remove completely empty rows
  data <- data_raw %>%
    filter(!is.na(Title) & Title != "" & Title != "Title") %>%
    # Select key columns of interest
    select(
      Title,
      Type,
      Topic,
      Organization,
      `RWD Type`,
      `URL(s)`,
      Description,
      `Intended Audience`,
      Availability = starts_with("Availability")
    )
  
}, error = function(e) {
  stop(paste("Error loading data from Google Sheets:", e$message, 
             "\nMake sure the sheet is public and the URL is correct."))
})

# Get last update time
last_update <- format(Sys.time(), "%B %d, %Y at %I:%M %p %Z")
```

## Key Metrics

::: {.metrics-grid}

::: {.metric-card}
<div class="metric-label">Total Resources</div>
<div class="metric-value">`r nrow(data)`</div>
:::

::: {.metric-card}
<div class="metric-label">Unique Organizations</div>
<div class="metric-value">`r length(unique(data$Organization[!is.na(data$Organization)]))`</div>
:::

::: {.metric-card}
<div class="metric-label">Resource Types</div>
<div class="metric-value">`r length(unique(data$Type[!is.na(data$Type)]))`</div>
:::

::: {.metric-card}
<div class="metric-label">Topics Covered</div>
<div class="metric-value">`r length(unique(unlist(strsplit(paste(data$Topic[!is.na(data$Topic)], collapse = ", "), ", "))))`</div>
:::

:::

## Visualizations

### Resources by Organization

::: {.chart-container}
```{r plot-organizations}
#| fig-width: 10
#| fig-height: 6

# Count resources by organization and group single-resource institutions
org_counts_raw <- data %>%
  filter(!is.na(Organization) & Organization != "") %>%
  count(Organization, sort = TRUE)

# Separate organizations with 1 resource vs. more than 1
org_counts <- org_counts_raw %>%
  mutate(Organization = ifelse(n == 1, "Other (single resource)", Organization)) %>%
  group_by(Organization) %>%
  summarise(n = sum(n), .groups = 'drop') %>%
  arrange(n)  # Sort for plotly

# Count how many institutions are in "Other"
other_count <- sum(org_counts_raw$n == 1)
other_label <- paste0("Other (", other_count, " institutions)")

# Update the label for "Other"
org_counts <- org_counts %>%
  mutate(Organization = ifelse(Organization == "Other (single resource)", 
                                other_label, 
                                Organization))

plot_ly(org_counts, 
        x = ~n, 
        y = ~Organization, 
        type = 'bar',
        orientation = 'h',
        marker = list(color = '#3498db'),
        text = ~paste0(Organization, ": ", n, " resources"),
        hoverinfo = 'text') %>%
  layout(title = list(text = "Organizations by Resource Count",
                      font = list(size = 16)),
         xaxis = list(title = "Number of Resources"),
         yaxis = list(title = "", categoryorder = "total ascending"),
         hovermode = "closest",
         margin = list(l = 200))
```
:::

### Distribution by RWD Type

::: {.chart-container}
```{r plot-rwd-types}
#| fig-width: 10
#| fig-height: 5

# Parse and count RWD Types (they may be comma-separated)
rwd_types <- data %>%
  filter(!is.na(`RWD Type`) & `RWD Type` != "") %>%
  separate_rows(`RWD Type`, sep = ",\\s*") %>%
  count(`RWD Type`, sort = TRUE) %>%
  head(12) %>%
  arrange(n)  # Sort for plotly

# Create color gradient
colors <- colorRampPalette(c("#3498db", "#2c3e50"))(nrow(rwd_types))

plot_ly(rwd_types, 
        x = ~n, 
        y = ~`RWD Type`, 
        type = 'bar',
        orientation = 'h',
        marker = list(color = colors),
        text = ~paste0(`RWD Type`, ": ", n, " resources"),
        hoverinfo = 'text') %>%
  layout(title = list(text = "Resources by RWD Type",
                      font = list(size = 16)),
         xaxis = list(title = "Count"),
         yaxis = list(title = "", categoryorder = "total ascending"),
         hovermode = "closest",
         showlegend = FALSE,
         margin = list(l = 150))
```
:::

### Topics Coverage

::: {.chart-container}
```{r plot-topics}
#| fig-width: 10
#| fig-height: 6

# Parse and count Topics (they may be comma-separated)
topics <- data %>%
  filter(!is.na(Topic) & Topic != "") %>%
  separate_rows(Topic, sep = ",\\s*") %>%
  count(Topic, sort = TRUE) %>%
  head(15) %>%
  arrange(n)  # Sort for plotly

plot_ly(topics, 
        x = ~n, 
        y = ~Topic, 
        type = 'bar',
        orientation = 'h',
        marker = list(color = '#27ae60'),
        text = ~paste0(Topic, ": ", n, " resources"),
        hoverinfo = 'text') %>%
  layout(title = list(text = "Top 15 Topics",
                      font = list(size = 16)),
         xaxis = list(title = "Number of Resources"),
         yaxis = list(title = "", categoryorder = "total ascending"),
         hovermode = "closest",
         margin = list(l = 150))
```
:::

### Availability Status

::: {.chart-container}
```{r plot-availability}
#| fig-width: 10
#| fig-height: 5

# Count by availability
availability <- data %>%
  filter(!is.na(Availability) & Availability != "") %>%
  separate_rows(Availability, sep = ",\\s*") %>%
  count(Availability, sort = TRUE) %>%
  mutate(Availability = reorder(Availability, n))

# Use native plotly for better pie chart
plot_ly(availability, 
        labels = ~Availability, 
        values = ~n, 
        type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        marker = list(colors = RColorBrewer::brewer.pal(n = nrow(availability), name = "Set3"))) %>%
  layout(title = list(text = "Resources by Availability", 
                      font = list(size = 16, family = "sans-serif")),
         showlegend = TRUE,
         legend = list(orientation = "v"))
```
:::

## Resource Inventory Table

::: {.chart-container}
```{r data-table}
library(DT)

# Create a display version with clickable URLs
data_display <- data %>%
  mutate(
    # Make URLs clickable if they exist
    URL = ifelse(!is.na(`URL(s)`) & `URL(s)` != "",
                 sprintf('<a href="%s" target="_blank">Link</a>', `URL(s)`),
                 ""),
    # Truncate description for display
    Description_Short = ifelse(!is.na(Description),
                               substr(Description, 1, 100),
                               "")
  ) %>%
  select(Title, Organization, Type, `RWD Type`, Topic, Availability, URL, Description_Short) %>%
  arrange(Organization, Title)

datatable(
  data_display,
  escape = FALSE,  # Allow HTML in URL column
  options = list(
    pageLength = 15,
    scrollX = TRUE,
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel'),
    columnDefs = list(
      list(width = '250px', targets = 0),  # Title
      list(width = '150px', targets = 1),  # Organization
      list(width = '100px', targets = c(2, 3, 5)),  # Type, RWD Type, Availability
      list(width = '150px', targets = 4),  # Topic
      list(width = '50px', targets = 6),   # URL
      list(width = '300px', targets = 7)   # Description
    )
  ),
  filter = "top",
  class = 'cell-border stripe hover',
  rownames = FALSE,
  colnames = c('Title', 'Organization', 'Type', 'RWD Type', 'Topic', 'Availability', 'URL', 'Description')
)
```
:::

::: {.last-updated}
Last updated: `r last_update`
:::

